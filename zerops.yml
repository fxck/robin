zerops:
  # `api` setups
  - setup: apiprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build api
        # Install isolated migration dependencies
        - cd migrate && pnpm install --frozen-lockfile --ignore-workspace
      deployFiles:
        - apps/api/.output
        - migrate
        - packages/database/migrations
        - scripts
      cache:
        - node_modules
        - apps/api/node_modules
      envVariables:
        CI: true
        API_BASE: ${RUNTIME_API_BASE}
        APP_URL: ${RUNTIME_APP_URL}
    run:
      base: nodejs@22
      ports:
        - port: 3000
          httpSupport: true
      initCommands:
        # Run migrations once per deployment version (execOnce provides idempotency)
        - cd migrate && zsc execOnce $appVersionId -- ./node_modules/.bin/drizzle-kit migrate
      start: node apps/api/.output/server/index.mjs
      crontab:
        # Sync Redis view counts to PostgreSQL every 5 minutes
        # Runs on single container only - Zerops handles idempotency
        - command: "node scripts/sync-views.mjs"
          timing: "*/5 * * * *"
          allContainers: false
      envVariables:
        NODE_ENV: production
        PORT: 3000
        NITRO_DATABASE_URL: ${db_connectionString}/${db_dbName}
        NITRO_REDIS_URL: ${redis_connectionString}
        NITRO_S3_ENDPOINT: ${storage_apiUrl}
        NITRO_S3_REGION: us-east-1
        NITRO_S3_BUCKET: ${storage_bucketName}
        NITRO_S3_ACCESS_KEY_ID: ${storage_accessKeyId}
        NITRO_S3_SECRET_ACCESS_KEY: ${storage_secretAccessKey}
        NITRO_CDN_HOST: ${storageCdnUrl}
        NITRO_PUBLIC_API_BASE: ${API_BASE}
        NITRO_PUBLIC_APP_URL: ${APP_URL}
      healthCheck:
        httpGet:
          port: 3000
          path: /health
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /health

  # `app` setups
  - setup: appprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build app
      envVariables:
        CI: true
        VITE_API_URL: ${RUNTIME_VITE_API_URL}
        CDN_HOST: https://static.cdn.zerops.app/robin.fxck.dev/
      deployFiles:
        - dist/apps/app/~
      cache:
        - node_modules
        - apps/app/node_modules
    run:
      base: static
