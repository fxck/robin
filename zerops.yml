zerops:
  - setup: apiprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build api
      deployFiles:
        - apps/api/.output
      cache:
        - node_modules
        - apps/api/node_modules
      envVariables:
        CI: "true"
    run:
      base: nodejs@22
      ports:
        - port: 3000
          httpSupport: true
      start: node apps/api/.output/server/index.mjs
      envVariables:
        NODE_ENV: production
        PORT: 3000
        DATABASE_URL: postgresql://${db_user}:${db_password}@${db_hostname}:${db_port}/${db_dbName}
        REDIS_URL: redis://${redis_hostname}:${redis_port}
        S3_ENDPOINT: ${storage_apiUrl}
        S3_REGION: us-east-1
        S3_BUCKET: ${storage_bucketName}
        S3_ACCESS_KEY_ID: ${storage_accessKeyId}
        S3_SECRET_ACCESS_KEY: ${storage_secretAccessKey}
      healthCheck:
        httpGet:
          port: 3000
          path: /health
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /health

  - setup: appprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build app
      envVariables:
        CI: "true"
        VITE_API_URL: ${RUNTIME_VITE_API_URL}
      deployFiles:
        - dist/apps/app/~
      cache:
        - node_modules
        - apps/app/node_modules
    run:
      base: static
