zerops:
  - setup: apiprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build api
      deployFiles:
        - apps/api/.output
      cache:
        - node_modules
        - apps/api/node_modules
      envVariables:
        CI: true
        API_BASE: ${RUNTIME_API_BASE}
        APP_URL: ${RUNTIME_APP_URL}
    run:
      base: nodejs@22
      ports:
        - port: 3000
          httpSupport: true
      start: node apps/api/.output/server/index.mjs
      envVariables:
        NODE_ENV: production
        PORT: 3000
        NITRO_DATABASE_URL: postgresql://${db_user}:${db_password}@${db_hostname}:${db_port}/${db_dbName}
        NITRO_REDIS_URL: redis://${redis_hostname}:${redis_port}
        NITRO_S3_ENDPOINT: ${storage_apiUrl}
        NITRO_S3_REGION: us-east-1
        NITRO_S3_BUCKET: ${storage_bucketName}
        NITRO_S3_ACCESS_KEY_ID: ${storage_accessKeyId}
        NITRO_S3_SECRET_ACCESS_KEY: ${storage_secretAccessKey}
        NITRO_PUBLIC_API_BASE: ${API_BASE}
        NITRO_PUBLIC_APP_URL: ${APP_URL}
      healthCheck:
        httpGet:
          port: 3000
          path: /health
    deploy:
      readinessCheck:
        httpGet:
          port: 3000
          path: /health

  - setup: appprod
    build:
      base: nodejs@22
      buildCommands:
        - pnpm install --frozen-lockfile
        - pnpm exec nx build app
      envVariables:
        CI: true
        VITE_API_URL: ${RUNTIME_VITE_API_URL}
      deployFiles:
        - dist/apps/app/~
      cache:
        - node_modules
        - apps/app/node_modules
    run:
      base: static
